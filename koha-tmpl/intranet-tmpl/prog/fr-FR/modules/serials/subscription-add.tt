[% INCLUDE 'doc-head-open.inc' %] <title>Koha &rsaquo; Périodiques &rsaquo; [% IF ( modify ) %][% bibliotitle |html %] &rsaquo; Modifier abonnement[% ELSE %]Ajouter abonnement[% END %]</title>
[% INCLUDE 'doc-head-close.inc' %] [% INCLUDE 'calendar.inc' %] <style type="text/css">
fieldset.rows li.radio { width: 100%; } /* override staff-global.css */
.yui-u li p label.widelabel {
    width: 300px;  /* not enough for IE7 apparently */
}
</style>
<script type="text/javascript">
//<![CDATA[

// the english words used in display purposes
var text = new Array(_("Numéro"),_("Volume"),_("Fascicule"),_("Month"),_("Semaine"),_("Commence par&nbsp;: "),_("Retour à&nbsp;: "),_("Choisir hémisphère&nbsp;: "),_("Nord"),_("Southern"),
_("Automne"),_("Hiver"),_("Spring"),_("Été"),_("Automne"),_("Saison"),_("Année"));
var weekno_label = _("Semaine #");
var is_season = 0;
var is_hemisphere = 1;
var irregular_issues;   // will hold irregularity object.

function formatDate(myDate) {
    var d = new Array( myDate.getFullYear(), myDate.getMonth() + 1 ,myDate.getDate());
    if(d[1].toString().length == 1) { d[1] = '0'+d[1] };
    if(d[2].toString().length == 1) { d[2] = '0'+d[2] };
    [% IF ( dateformat_us ) %]
        return(d[1] + '/' + d[2] + '/' + d[0]) ;
    [% ELSIF ( dateformat_metric ) %]
        return(d[2] + '/' + d[1] + '/' + d[0]) ;
    [% ELSE %]
        return(''+d[0] + '-' + d[1] + '-' + d[2]) ;
    [% END %]    
}

Date.prototype.addDays = function(days) {
    this.setDate(this.getDate()+days);
}

function getWeeksArray(startDate,periodicity) {
// returns an array of syspref-formatted dates starting at the first day of startDate's year.
// This prediction method will not accurately predict irregularites beyond the first year.
// FIXME : Should replace with ajax query to get the first Monday of the year so that week numbers have correct dates.
    var incr=1;
    if(periodicity==3) {  // 1/2 wks
        incr=2;
    } else if(periodicity == 4) { // 1/3 wks
        incr=3;
    }
    var weeksArray = new Array;
    var jan01 = new Date();
    jan01.setDate(1);
    jan01.setMonth(0);
    jan01.setFullYear(startDate.getFullYear());
    for(var i=0;i<52;i++) {
        weeksArray[i] = formatDate(jan01) + ' ' + weekno_label + (i + 1);
        jan01.addDays( 7 ); 
    }
    return weeksArray;
}

function YMDaToYWDa(S) {
    with (new Date(Date.UTC(S[0], S[1] - 1, S[2]))) {
        var DoW = getUTCDay();
        setUTCDate(getUTCDate() - (DoW + 6) % 7 + 3);
        var ms = valueOf();
        setUTCMonth(0, 4);
        var WN = Math.round((ms - valueOf()) / 604800000) + 1;
        return [getUTCFullYear(), WN, DoW == 0 ? 7 : DoW];
    }
}
function dayofyear(d) { // d is a Date object
var yn = d.getFullYear();
var mn = d.getMonth();
var dn = d.getDate();
var d1 = new Date(yn,0,1,12,0,0); // noon on Jan. 1
var d2 = new Date(yn,mn,dn,12,0,0); // noon on input date
var ddiff = Math.round((d2-d1)/864e5);
return ddiff+1;
}


// create irregularity object.
function IrregularPattern() {
	this.months = new Array(_("Janvier"),_("Février"),_("Mars"),_("Avril"),_("Mai"),_("Juin"),_("Juillet"),_("Août"),_("Septembre"),_("Octobre"),_("Novembre"),_("December"));
	this.seasons = new Array(_("Automne"),_("Hiver"),_("Spring"),_("Été"),_("Automne"));
    this.daynames = new Array(_("Lundi"),_("Mardi"),_("Mercredi"),_("Jeudi"),_("Vendredi"),_("Samedi"),_("Dimanche"));
    // create weeks irregularity selection array:
    this.firstissue = new Date();
    this.firstissue.setDate(1);
    this.firstissue.setMonth(0);
    [% IF ( firstacquiyear ) %] // it's a mod, we already have a start date.
        this.firstissue.setFullYear( [% firstacquiyear %] );
    [% END %]
   	this.weeks = getWeeksArray(this.firstissue); 

    this.numskipped = 0;
    // init:
	var irregular = '[% irregularity %]';
    this.skipped = irregular.split(',');
}

IrregularPattern.prototype.update = function() {
		this.skipped= new Array;
		var cnt = 0;
		// daily periodicity, we interpret irregular array as which days of week to skip.
		// else if weekly periodicity, week numbers (starting from 01 Jan) to skip.
        // else  irregular array is list of issues to skip
		var summary_str = '';
		this.numskipped = 0;
        if(document.f.irregularity_select) {
            //$("#irregularity_select option:selected").each(...); //jquery can combine both conditionals and the for loop
            for( var i in document.f.irregularity_select.options ) {
                if( document.f.irregularity_select.options[i].selected ) {
                    this.skipped[cnt] = document.f.irregularity_select.options[i].value ;
                    summary_str += document.f.irregularity_select.options[i].text + "\n" ;
				    cnt++;
				    this.numskipped++;
			    }
		    }
		    var summary = document.getElementById("irregularity_summary");
		    if(summary) {
			    summary.value = summary_str;
			    summary.rows= ( cnt > 6 ) ? cnt : 6 ; // textarea will bre resized, but not more than 6 lines will show.
		    }
        }
}

IrregularPattern.prototype.irregular = function(index) { 
	for( var i in this.skipped) {
			if( this.skipped[i] == index) {
				return true;
			}
	}
	return false;
}

function init_pattern() {
	irregular_issues = new IrregularPattern();
}
function reset_pattern() {
	document.getElementById("numberpattern").value = '';
    document.getElementById("irregularity").innerHTML = '';
	init_pattern();
	reset_num_pattern();
}

// common pre defined number patterns
function reset_num_pattern() {
var patternchoice = document.getElementById("numberpattern").value;
    switch(patternchoice){
    case "2":
        document.f.add1.value=1;
        document.f.add2.value=1;
        document.f.add3.value=1;
        document.f.every1.value=12;
        document.f.every2.value=1;
        document.f.every3.value=1;
        document.f.whenmorethan1.value=9999999;
        document.f.whenmorethan2.value=12;
        document.f.whenmorethan3.value=4;
        document.f.setto1.value=0;
        document.f.setto2.value=1;
        document.f.setto3.value=1;
        document.f.lastvalue1.value=1;
        document.f.lastvalue2.value=1;
        document.f.lastvalue3.value=1;
        document.f.numberingmethod.value=_("Vol {X}, N° {Y}, Fascicule {Z}");
        moreoptions(text[1],text[0],text[2]);
        display_table(0); // toggle info box on (1) or off (0)
        break;
    case "3":
        document.f.add1.value=1;
        document.f.add2.value=1;
        document.f.add3.value='';
        document.f.every1.value=12;
        document.f.every2.value=1;
        document.f.every3.value='';
        document.f.whenmorethan1.value=9999999;
        document.f.whenmorethan2.value=12;
        document.f.whenmorethan3.value='';
        document.f.setto1.value=0;
        document.f.setto2.value=1;
        document.f.setto3.value='';
        document.f.lastvalue1.value=1;
        document.f.lastvalue2.value=1;
        document.f.lastvalue3.value='';
        document.f.numberingmethod.value=_("Vol {X}, N° {Y}");
        moreoptions(text[1],text[0]);
        display_table(0);
        break;
    case "4":
        document.f.add1.value=1;
        document.f.add2.value=1;
        document.f.add3.value='';
        document.f.every1.value=12;
        document.f.every2.value=1;
        document.f.every3.value='';
        document.f.whenmorethan1.value=9999999;
        document.f.whenmorethan2.value=12;
        document.f.whenmorethan3.value='';
        document.f.setto1.value=0;
        document.f.setto2.value=1;
        document.f.setto3.value='';
        document.f.lastvalue1.value=1;
        document.f.lastvalue2.value=1;
        document.f.lastvalue3.value='';
        document.f.numberingmethod.value=_("Volume {X}, Fascicule {Y}");
        moreoptions(text[1],text[2]);
        display_table(0);
        break;
    case "5":
//        var d = new Date(document.f.firstacquidate.value);
//        var smonth = d.getMonth();
        document.f.add1.value=1;
        document.f.add2.value=1;
        document.f.add3.value='';
        document.f.every1.value=12;
        document.f.every2.value=1;
        document.f.every3.value='';
        document.f.whenmorethan1.value=9999999;
        document.f.whenmorethan2.value=12;
        document.f.whenmorethan3.value='';
        document.f.setto1.value=0;
        document.f.setto2.value=1;
        document.f.setto3.value='';
        document.f.numberingmethod.value=_("N° {X}, Fascicule {Y}");
        moreoptions(text[0],text[2]);
        display_table(0);
        break;
    case "6":
        var d = new Date(document.f.firstacquidate.value);
        var sYear = d.getFullYear();
        moreoptions_seasons(text[15],sYear);
        var d = new Date(document.f.firstacquidate.value);
        var sYear = d.getFullYear();
        document.f.add1.value=1;
        document.f.add2.value='1';
        document.f.add3.value='';
        document.f.every1.value=4;
        document.f.every2.value='1';
        document.f.every3.value='';
        document.f.whenmorethan1.value=9999999;
        document.f.whenmorethan2.value='4';
        document.f.whenmorethan3.value='';
        document.f.setto1.value=0;
        document.f.setto2.value='1';
        document.f.setto3.value='';
        document.f.periodicity.value='8';
        document.f.numberingmethod.value=_("{Y} {X}");
        moreoptions_seasons(text[15],sYear);
        document.f.lastvalue1temp.value=document.f.lastvalue1.value=sYear;
        display_table(0);
        is_season = 1;
        break;
    case "7":
        display_table(1);
        document.getElementById("more_options").innerHTML = '';
        document.f.irreg_check.value=1; 
        break;
    case "8":  // Year/Number
        var d = (document.f.firstacquidate.value) ? new Date( document.f.firstacquidate.value) : new Date() ;
        var sYear = d.getFullYear();
        document.f.add1.value=1;
        document.f.add2.value=1;
        document.f.add3.value='';
        document.f.every1.value=12;
        document.f.every2.value=1;
        document.f.every3.value='';
        document.f.whenmorethan1.value=9999999;
        document.f.whenmorethan2.value=12;
        document.f.whenmorethan3.value='';
        document.f.setto1.value=0;
        document.f.setto2.value=1;
        document.f.setto3.value='';
        document.f.lastvalue1.value=sYear;
          switch (document.f.periodicity.value){
            case 1:              
              var doy = dayofyear(d);
              document.f.lastvalue2.value=doy; 
              document.f.whenmorethan2.value=365; 
              break;      
            case 12:     
              var doy = dayofyear(d);
              document.f.lastvalue2.value=doy*2; 
              document.f.whenmorethan2.value=730; 
              break;      
            case 2:
            case 3:
            case 4:
              var YWDa = YMDaToYWDa(d);
              document.f.lastvalue2.value=YWDA[1]/(document.f.periodicity.value-1); 
              break;      
            case 5:
              var smonth = d.getMonth();
              document.f.lastvalue2.value=smonth;
              break;      
            case 6:
              var smonth = d.getMonth();
              document.f.lastvalue2.value=smonth/2;
              document.f.whenmorethan2.value=6;
              break;      
            case 7:
            case 8:      
              var smonth = d.getMonth();
              document.f.lastvalue2.value=smonth/3;
              document.f.whenmorethan2.value=4;
              break;      
            case 9:                        
              var smonth = d.getMonth();
              document.f.lastvalue2.value=smonth/6;
              document.f.whenmorethan2.value=2;
              break;      
            default:
          } 
        document.f.lastvalue3.value='';
        document.f.numberingmethod.value=_("{X} / {Y}");
        moreoptions(text[16],text[0]);
     //   document.f.lastvalue1temp.value=sYear;
     //   document.f.lastvalue2temp.value=document.f.lastvalue2.value;
        display_table(0);
        break;
    default:
        document.f.add1.value=1;
        document.f.add2.value='';
        document.f.add3.value='';
        document.f.every1.value=1;
        document.f.every2.value='';
        document.f.every3.value='';
        document.f.whenmorethan1.value=9999999;
        document.f.whenmorethan2.value='';
        document.f.whenmorethan3.value='';
        document.f.setto1.value=0;
        document.f.setto2.value='';
        document.f.setto3.value='';
        document.f.lastvalue1.value=1;
        document.f.lastvalue2.value='';
        document.f.lastvalue3.value='';
        document.f.numberingmethod.value='{X}';
//        moreoptions_daily_check(text[0]);
        moreoptions(text[0]);
        document.f.irreg_check.value=1;
        display_table(0);
        break;
    }
}

function display_table(n) {
    if(n==1){
        document.getElementById("basetable").style.display = 'block';
    } else if(n==0){
        document.getElementById("basetable").style.display = 'none';
    } else {
		var disp_val = ( document.getElementById("basetable").style.display == 'none' ) ? 'block' : 'none' ;
			document.getElementById("basetable").style.display = disp_val;
	}
}

function set_num_pattern_from_template_vars() {
	if(!document.getElementById("numberpattern")){ return false; }
    document.getElementById("numberpattern").value = '[% numberpattern %]';
    reset_num_pattern();
    
    document.f.add1.value='[% add1 %]';
    document.f.add2.value='[% add2 %]';
    document.f.add3.value='[% add3 %]';
    document.f.every1.value='[% every1 %]';
    document.f.every2.value='[% every2 %]';
    document.f.every3.value='[% every3 %]';
    document.f.whenmorethan1.value='[% whenmorethan1 %]';
    document.f.whenmorethan2.value='[% whenmorethan2 %]';
    document.f.whenmorethan3.value='[% whenmorethan3 %]';
    document.f.setto1.value='[% setto1 %]';
    document.f.setto2.value='[% setto2 %]';
    document.f.setto3.value='[% setto3 %]';
    document.f.lastvalue1.value='[% lastvalue1 %]';
    document.f.lastvalue2.value='[% lastvalue2 %]';
    document.f.lastvalue3.value='[% lastvalue3 %]';
    document.f.numberingmethod.value='[% numberingmethod %]';

    var more_strY;
    var more_strZ;
    [% IF ( add2 ) %]
    if([% add2 %] > 0){
        more_strY="Y";
    }
    [% END %]
    [% IF ( add3 ) %]
    if([% add3 %] > 0){
        more_strZ="Z";
    }
    [% END %]
    document.f.lastvalue1temp.value='[% lastvalue1 %]';
    if(more_strY){
        document.f.lastvalue2temp.value='[% lastvalue2 %]';
    document.f.whenmorethan2temp.value='[% whenmorethan2 %]';
    }
    if(more_strZ){
        document.f.lastvalue3temp.value='[% lastvalue3 %]';
    document.f.whenmorethan3temp.value='[% whenmorethan3 %]';
    }
}

// a pre check with more options to see if 'number' and '1/day' are chosen
function moreoptions_daily_check(x) {
    var periodicity = document.f.periodicity.value;
    var errortext='';
    if(periodicity == 1){ // i.e. daily
        document.getElementById("irregularity").innerHTML = '';
        errortext =_("Indiquer, SVP, quels jours de la semaine vous  <b>N'ATTENDEZ PAS</b> de numéros.")+"<br \/>";
        for(var j=0;j<irregular_issues.daynames.length;j++){
            errortext +="<input type='checkbox' name='irregular' id='irregular"+(j+1)+"' value='"+(j+1)+"' />"+irregular_issues.daynames[j]+" &nbsp; ";
        }
        var error = errortext;
        moreoptions(x);
        document.getElementById("irregularity").innerHTML = error;
    } else {
        document.getElementById("irregularity").innerHTML = '';
        document.getElementById("more_options").innerHTML = '';
        moreoptions(x);
    }
}

// to dispaly the more options section
function moreoptions(x,y,z){
document.getElementById("irregularity").innerHTML = '';
document.getElementById("more_options").innerHTML = '';
var textbox = '';
    // alert("X: "+x+"Y: "+y+"Z: "+z);
    if(x){
        textbox +="<table id='irregularity_table'>\n<tr><th>&nbsp;<\/th><th>"+x+"<\/th>";
        if(y){
            textbox +="<th>"+y+"<\/th>";
            if(z){
                textbox +="<th>"+z+"<\/th>";
            }
        }
        textbox +="<\/tr>\n";
        textbox +="<tr><th scope=\"row\">"+text[5]+"<\/td><td><input type='text' name='lastvalue1temp' id='lastvalue1temp' size='4' onkeyup='moreoptionsupdate(this)' value=\"" + document.f.lastvalue1.value +  "\" /><\/td>\n";
        if(y){
            textbox +="<td><input type=\"text\" name=\"lastvalue2temp\" id=\"lastvalue2temp\" size=\"4\" onkeyup=\"moreoptionsupdate(this)\" value=\"" + document.f.lastvalue2.value + "\" /><\/td>\n";
            if(z){
                textbox +="<td><input type=\"text\" name=\"lastvalue3temp\" id=\"lastvalue3temp\" size=\"4\" onkeyup=\"moreoptionsupdate(this)\" value=\"" + document.f.lastvalue3.value + "\" /><\/td>\n";
            }
        }
        textbox +="<\/tr>\n";
        if(y){
            textbox +="<tr><th scope=\"row\">"+text[6]+"<\/th>";
            textbox +="<td>&nbsp;<\/td>\n";
            textbox +="<td><input type=\"text\" name=\"whenmorethan2temp\" id=\"whenmorethan2temp\" size=\"4\" onkeyup=\"moreoptionsupdate(this,1)\"><\/td>\n";
            if(z){
                textbox +="<td><input type=\"text\" name=\"whenmorethan3temp\" id=\"whenmorethan3temp\" size=\"4\" onkeyup=\"moreoptionsupdate(this,1)\"><\/td>\n";
            }
            textbox +="<\/tr>";
        } else {
          textbox +="<tr> <td>"+_("fascicules attendus")+"<\/td><td><input type=\"text\" name=\"issuesexpected1temp\" id=\"issuesexpected1temp\" size=\"4\" onkeyup=\"moreoptionsupdate(this,0)\" value=\"" + document.f.issuesexpected1.value + "\" ><\/td><\/tr>";
        }
        textbox +="<\/table>\n";
    }
    document.getElementById("more_options").innerHTML = textbox;
}

function hemispheres(chosen){
var selbox = document.getElementById("season1");
    if(selbox){
    var selboxselected = selbox.options[selbox.selectedIndex].value;
    selbox.options.length = 0;

    if ( (chosen == "1") || ( ! (chosen) && is_hemisphere == 1 )) {
        selbox.options[selbox.options.length] = new Option(text[11],'1');
        selbox.options[selbox.options.length] = new Option(text[12],'2');
        selbox.options[selbox.options.length] = new Option(text[13],'3');
        selbox.options[selbox.options.length] = new Option(text[14],'4');
        is_hemisphere = 1;
        selbox.options[selboxselected-1].selected = true;
    }

    if ( (chosen == "2") || ( ! (chosen) && is_hemisphere == 2 )) {
        selbox.options[selbox.options.length] = new Option(text[13],'1');
        selbox.options[selbox.options.length] = new Option(text[10],'2');
        selbox.options[selbox.options.length] = new Option(text[11],'3');
        selbox.options[selbox.options.length] = new Option(text[12],'4');
        is_hemisphere = 2;
        selbox.options[selboxselected-1].selected = true;
    }
    }
}

// to display the more options section for seasons
function moreoptions_seasons(x,y){
// x = 'Season'.  y = 'Year'.
document.getElementById("irregularity").innerHTML = '';
document.getElementById("more_options").innerHTML = '';
var textbox = '';
    //alert("X: "+x+"Year: "+y);
    if(x){
        var hemi_select = parseInt('[% hemisphere %]');
        textbox +="<li><label for=\"hemisphere\">"+ text[7]  +"<\/label><select name=\"hemisphere\" id=\"hemisphere\" onchange=\"hemispheres(this.options[this.selectedIndex].value)\">";
        for(var i = 1; i <= 2; i++){
            textbox +="<option value='"+i+"'";
            if(i == hemi_select){
                textbox += " selected "
            }
            textbox +=">"+text[i+7]+"<\/option>";
        }
        textbox +="<\/li>\n";
        textbox +="<table id=\"seasonal_irregularity\"><tr><th>&nbsp;<\/th><th>"+x+"<\/th>";
        textbox +="<th>"+text[16]+"<\/th>";
        textbox +="<\/tr>\n";
        textbox +="<tr><th scope=\"row\">"+text[5]+"<\/th><td><select name=\"lastvalue2temp\" id=\"lastvalue2temp\" id=\"season1\" onchange=\"moreoptionsupdate(this)\">";
        for(var j = 1; j <= 4; j++){
            textbox +="<option value='"+j+"'>"+text[j+9]+"<\/option>";
        }
        textbox +="<\/select><\/td>";
        var isyr = irregular_issues.firstissue;
        textbox += "<td>" + irregular_issues.firstissue.getFullYear() + "<\/td><\/tr>\n";
        textbox +="<tr><th scope=\"row\">"+text[6]+"<\/th>";
        textbox +="<td><input type=\"text\" name=\"whenmorethan2temp\" id=\"whenmorethan2temp\" size=\"4\" onkeyup=\"moreoptionsupdate(this,1)\"><\/td>\n";
        textbox +="<\/tr><\/table>\n";
    }
    document.getElementById("more_options").innerHTML = textbox;
}

function irregularity_check(){
    document.f.irreg_check.value = 1; // Irregularity button now pushed
    var periodicity = document.f.periodicity.value;
	var rollover = document.f.issuesexpected1.value;
    if( (document.f.whenmorethan2) && ( document.f.whenmorethan2.value > 0) ){
      rollover = document.f.whenmorethan2.value;
    }
    if((document.f.whenmorethan3) && document.f.whenmorethan3.value > 0 ){
        // FIXME: Irregularity check assumes that the full prediction pattern repeats each year.
		//  In cases where the outermost periodicity is > 1 year,  
		//  e.g. where a volume spans two years, the irregularity check will be incorrect, 
        // but you can safely ignore the check, submit the form, and the prediction pattern should be correct.
		//  a way to distinguish between these two cases is needed.
		rollover = document.f.whenmorethan3.value * document.f.whenmorethan2.value;
    }
    var error='';
    var toobig;
    var expected; 
    var errortext = "<b>"+_("Attention irrégularité repérée")+"</b><br \/>";
    switch(periodicity){
    case "12":
        if(rollover < 730) expected =730;
        if(rollover > 730) {
            expectedover=730;
            toobig=1;
        }
        break;
    case "1":
        if(rollover < 365) expected =365;
        if(rollover > 365) {
            expectedover=365;
            toobig=1;
        }
        break;
    case "2":
        if(rollover < 52) expected =52;
        if(rollover > 52){
            expectedover=52;
            toobig=1;
        }
        break;
    case "3":
        if(rollover < 26) expected =26;
        if(rollover > 26){
            expectedover=26;
            toobig=1;
        }
        break;
    case "4":
        if(rollover < 17) expected =17;
        if(rollover > 17){
            expectedover=17;
            toobig=1;
        }
        break;
    case "5":
        if(rollover < 12) expected =12;
        if(rollover > 12){
            expectedover=12;
            toobig=1;
        }
        break;
    case "6":
        if(rollover < 6) expected =6;
        if(rollover > 6){
            expectedover=6;
            toobig=1;
        }
        break;
    case "7":
        if(rollover < 4) expected =4;
        if(rollover > 4){
            expectedover=4;
            toobig=1;
        }
        break;
    case "8":
        if(rollover < 4) expected =4;
        if(rollover > 4){
            expectedover=4;
            toobig=1;
        }
        break;
    case "9":
        if(rollover < 2) expected =2;
        if(rollover > 2){
            expectedover=2;
            toobig=1;
        }
        break;
    case "10":
        if(rollover < 1) expected =1;
        if(rollover > 1){
            expectedover=1;
            toobig=1;
        }
        break;
    default:
        break;
    }
    if(expected){
        if(expected == 365 || expected==730){  // what about leap years ?
			// FIXME:  We interpret irregularity as which days per week for periodicity==1.
			//  We need two cases: one in which we're published n days/week, in which case irregularity should be per week,
			//  and a regular daily pub, where irregularity should be per year.
            errortext += _("Indiquer, SVP, quels jours de la semaine vous  <b>N'ATTENDEZ PAS</b> de numéros.")+"<br \/>";
        } else {
            errortext +=expected+_(" numéro(s) attendu(s), ")+rollover+_(" ont été saisis.")+"<br \/>"+_("Merci de signaler à quelle(s) date(s) vous n'attendez pas de numéro")+"<br \/>";
            irregular_issues.numskipped = expected - rollover;
		}
        errortext +="<select multiple id=\"irregularity_select\" name=\"irregularity_select\" onchange=\"irregular_issues.update();\">\n";
		errortext +=irregular_options(periodicity);
		errortext += "<\/select>\n <textarea rows=\"6\" width=\"18\" id=\"irregularity_summary\" name=\"irregularity_summary\" value=\"foo\"><\/textarea>";
        error=errortext;
    }
    if(toobig){
        errortext +=expectedover+_(" numéro(s) attendu(s), ")+rollover+_(" ont été saisis")+"<p class=\"warning\">"+_("Vous semblez avoir signalé plus de numéros par an que prévu.<\\/p>");
        error=errortext;
    }
    if(error.length ==0){
        error=_("Pas d irrégularités détectées");
    }
	display_example(expected);
    document.getElementById("irregularity").innerHTML = error;
	irregular_issues.update();
}

function irregular_options(periodicity){
    var titles;
    var count;
    var errortext='';
    var numberpattern = document.getElementById('numberpattern').value;
    if(periodicity == 1) {
        expected = 7;
        titles = irregular_issues.daynames;
        count = 1;
    }
    if(periodicity == 2 || periodicity == 3 || periodicity == 4) { 
        titles = irregular_issues.weeks;
		count = 1;
        if(periodicity==3) {  // 1/2 wks
            expected = 26;
        } else if(periodicity == 4) { // 1/3 wks
            expected = 17;
        } else {
            expected = 52;
        }
    }
    if(periodicity == 5 || periodicity == 6 || periodicity == 7 || periodicity == 8 || periodicity == 9) {
        if(periodicity == 8 && numberpattern==8) {
            is_season = 1; // setting up from edit page
        } 
        if(is_season){
            titles = irregular_issues.seasons;
            expected = 4;
            if(is_hemisphere == 2){
                count = 2;
            } else {
                count = 1;
            }
        } else {
            titles = irregular_issues.months;
            expected = 12;
            count = 1;
        }
    }
	if( !expected) {
		return '';   // don't know how to deal with irregularity.
	} 	
    for(var j=0;j<expected;j++){   // rch - changed frrom (1..expected).
        if(isArray(titles)){
            if(count>expected){
                count = count-expected;
            }
            if(is_season && is_hemisphere == 1){
                errortext +="<option value='"+((count*3)-2)+"'>"+titles[j]+"<\/option>\n";
// alert("value: "+((count*3)-2)+" title: "+titles[j]);
            } else if(is_season && is_hemisphere == 2){
                errortext +="<option value='"+((count*3)-2)+"'>"+titles[j-1]+"<\/option>\n";
// alert("value: "+((count*3)-2)+" title: "+titles[j-1]);
            } else {  // all non-seasonal periodicities:
                var incr=1; // multiplier for ( 1/n weeks)  patterns; in this case the irreg calc relies on the week# , not the issue#.
                if(periodicity==3) {  // 1/2 wks
                    incr=2;
                } else if(periodicity == 4) { // 1/3 wks
                    incr=3;
                }
                errortext += "<option value='" + (1+j*incr) ;  
				if(irregular_issues.irregular(1+incr*j)) {
					errortext += "' selected='selected" ;
				}
				errortext += "'>"+titles[incr*j]+"<\/option>\n";
            }
            count++;
        } else { 
            errortext +="<option value='"+j+"'>"+titles+" "+j+"<\/option>\n";
        }
    }
    return errortext;
}


function display_example(expected){
    var startfrom1 = parseInt(document.f.lastvalue1.value);
    var startfrom2 = parseInt(document.f.lastvalue2.value);
    var startfrom3 = parseInt(document.f.lastvalue3.value);
    var every1 = parseInt(document.f.every1.value);
    var every2 = parseInt(document.f.every2.value);
    var every3 = parseInt(document.f.every3.value);
    var numberpattern = document.f.numberingmethod.value;
    var whenmorethan2 = parseInt(document.f.whenmorethan2.value);
    var whenmorethan3 = parseInt(document.f.whenmorethan3.value);
    var setto2 = parseInt(document.f.setto2.value);
    var setto3 = parseInt(document.f.setto3.value);
    var displaytext = _("Selon les informations entrées, le prévisionnel de bulletinage sera le suivant :") + "<br \/><ul class=\"numpattern_preview\">";
    if(startfrom3>0){
        var count=startfrom3-1;
        var count2=startfrom2;
        for(var i = 0 ; i < 12; i++){
            if(count>=whenmorethan3){
                count=setto3;
                if(count2>=whenmorethan2){
                    startfrom1++;
                    count2=setto2;
                } else {
                    count2++;
                }
            } else {
                count++;
            }
            displaytext += '<li>' + numberpattern.replace(/{Z}/,count) + '<\/li>\n';
            displaytext = displaytext.replace(/{Y}/,count2);
            displaytext = displaytext.replace(/{X}/,startfrom1);

        }
    }
    if(startfrom2>0 && !startfrom3){
        var count=startfrom2-1;
        for(var i=0;i<12;i++){
            if(count>=whenmorethan2){
                startfrom1++;
                count=setto2;
            } else {
                count++;
            }

            if(is_season){
                if(is_hemisphere == 2){
                    if(count == 1) {
                        displaytext += numberpattern.replace(/{Y}/,text[count+12])+'\n';
                    } else {
                        displaytext += numberpattern.replace(/{Y}/,text[count+8])+'\n';
                    }
                } else {
                displaytext += numberpattern.replace(/{Y}/,text[count+10])+'\n';
                }
            } else {
                displaytext += numberpattern.replace(/{Y}/,count)+'\n';
            }
            displaytext = displaytext.replace(/{X}/,startfrom1)+'<br \/>\n';
        }
    }
    if(startfrom1>0 && !startfrom2 && !startfrom3){
        var offset=eval(document.f.issuesexpected1.value);
        if (!offset){
            offset = 12 
        }
        for(var i=startfrom1;i<(startfrom1+offset);i+=every1){
            displaytext += numberpattern.replace(/{X}/,i)+'<br \/>\n';
        }
    }
   //  displaytext = "<div style='padding: 5px; background-color: #CCCCCC'>"+displaytext+"<\/div>";
    document.getElementById("displayexample").innerHTML = displaytext;
}

function isArray(obj) {
if (obj.constructor.toString().indexOf("Array") == -1)
    return false;
else
    return true;
}

function moreoptionsupdate(inputfield,rollover){
    fieldname = inputfield.name;
    // find parent element in base table by stripping 'temp' from element name.
    basefield = document.getElementById(fieldname.slice(0,-4));
    var fieldnumber = fieldname.slice(-5,-4);

    basefield.value = inputfield.value;
    var patternchoice = document.getElementById("numberpattern").value;
    switch(patternchoice){
    case "2":
    case "4":
    case "5":
    case "8": // Year, Number.  -- Why not just use Vol, Number withvol==year??
                //  FIXME: this my conflict with innerloop calc below.
       if (document.f.lastvalue2temp.value > 0){document.f.innerloop1.value = document.f.lastvalue2temp.value - 1;}
      break;   
    }  
    if(basefield.name.slice(0,-1) == 'lastvalue' || 'whenmorethan' ) {
        // The enumeration string is held in a positional numeral notation with three positions, X,Y,Z.
        // The last values lastvalue1, lastvalue2,lastvalue3 should match the last received serial's X,Y,Z enumeration.
        // make array indexes start with 1 for consistency with variable names.
        var innerloop = new Array( undefined, document.getElementById('innerloop1'), document.getElementById('innerloop2'), document.getElementById('innerloop3') );
        var lastvalue = new Array( undefined, document.getElementById('lastvalue1').value *1 , document.getElementById('lastvalue2').value *1 , document.getElementById('lastvalue3').value *1  );
        var every = new Array( undefined, document.getElementById('every1').value *1 , document.getElementById('every2').value *1 , document.getElementById('every3').value *1  );
        var add = new Array( undefined, document.getElementById('add1').value *1 , document.getElementById('add2').value *1 , document.getElementById('add3').value *1  );
        var whenmorethan = new Array( undefined, document.getElementById('whenmorethan1').value *1 , document.getElementById('whenmorethan2').value *1 , document.getElementById('whenmorethan3').value *1  );
        
       if(rollover){
       // calculate rollover  for higher level of periodicity.
       // if there are two levels of periodicity, (e.g. vol{X},num{Y},issue{Z}, then every1=every2*whenmorethan2 / add2 .
          for(var N=3;N>1;N--){
            if( add[N] > 0){
                var addN = (add[N]) ? add[N] : 1 ;
                var everyN = (document.getElementById('every'+N)) ? document.getElementById('every'+N).value : 1 ;
                document.getElementById('every'+(N-1)).value = whenmorethan[N] * everyN / addN ;
            }
          }
        }
        innerloop[3].value = ( every[3] > 1 ) ? lastvalue[3] % every[3] : 0 ;
        innerloop[2].value = ( every[2] > 1 ) ? lastvalue[3] - 1 : 0 ;
        innerloop[1].value = ( every[1] > 1 ) ? 
                                    ( whenmorethan[3] > 0 ) ?  (lastvalue[2] - 1) * every[2] + 1* innerloop[2].value 
                                                            : lastvalue[2] - 1
                                               : 0 ;
    }
     //FIXME : add checks for innerloop || lastvalue .gt. rollover  
}


function check_input(e){
    var unicode=e.charCode? e.charCode : e.keyCode
    if (unicode!=8 && unicode !=46 && unicode!=9 && unicode !=13){ // if key isn't backspace or delete
        if (unicode<48||unicode>57) { // if not a number
            alert(_("Needs to be entered in digit form -eg 10"));
            return false // disable key press
        }
    }
}

function addbiblioPopup(biblionumber) {
	var destination = "/cgi-bin/koha/cataloguing/addbiblio.pl?mode=popup";
	if(biblionumber){ destination += "&biblionumber="+biblionumber; }
 window.open(destination,'AddBiblioPopup','width=1024,height=768,toolbar=no,scrollbars=yes');
}

function Plugin(f)
{
	 window.open('subscription-bib-search.pl','FindABibIndex','width=800,height=400,toolbar=no,scrollbars=yes');
}

function FindAcqui(f)
{
	 window.open('acqui-search.pl','FindASupplier','width=800,height=400,toolbar=no,scrollbars=yes');
}

function Find_ISSN(f)
{
	 window.open('issn-search.pl','FindABibIndex','width=800,height=400,toolbar=no,scrollbars=yes');
}


function Check(f) {
    if (f.aqbooksellerid.value.length==0) {
        input_box = confirm(_("Si vous voulez réclamer les bulletins manquant ou en retard, vous devez relier cet abonnement à un fournisseur. Cliquez sur OK pour ignorer ou Annuler pour retourner saisir un fournisseur."));
		if (input_box==true) {
		}
		else {
			return false;
		}
    }
	if (f.biblionumber.value.length==0) {
        alert(_("Vous devez choisir ou créer une notice"));
    } else if(f.startdate.value.length != 0 && f.sublength.value > 0) {
        if (f.irreg_check.value == 1) {
            document.f.submit();
        } else {
            if(f.numbering_pattern.value == ''){
                alert(_("Vous devez choisir une formule de numérotation"));
            } else {
                alert(_("Vous devez vérifier les irrégularités en cliquant sur 'Testez le modèle prévisionnel'"));
            }
        }
    } else {
        alert(_("Vous devez choisir une date de départ et une durée d'abonnement"));
    }
	if(irregular_issues.numskipped < irregular_issues.skipped.length ) {
		alert(_("Vous n'avez pas pris en compte tous les fascicules manquants."));
	}
    return false;
}

$(document).ready(function() {
    init_pattern();
    // http://jqueryui.com/demos/datepicker/#date-range
    var dates = $( "#histstartdate, #histenddate" ).datepicker({
        changeMonth: true,
        numberOfMonths: 1,
        onSelect: function( selectedDate ) {
            var option = this.id == "histstartdate" ? "minDate" : "maxDate",
                instance = $( this ).data( "datepicker" );
                date = $.datepicker.parseDate(
                    instance.settings.dateFormat ||
                    $.datepicker._defaults.dateFormat,
                    selectedDate, instance.settings );
            dates.not( this ).datepicker( "option", option, date );
        }
    });

    [% IF ( manualhistory ) %] $("#subscription_form_history").show();[% END %]
	$("#cancel_manual_history").click(function(){
		$("#subscription_form_history").hide();
        $("#manuallist").removeAttr("checked");
	});
   	$("#manuallist").click( function(){
		if($(this).attr("checked")){
			$("#subscription_form_history").show();
		} else {
			$("#subscription_form_history").hide();
		}
	}
	);
   //  $(".widelabel").attr("width", "300px");  // labels stay skinny in IE7 anyway.
[% IF ( modify ) %]
    set_num_pattern_from_template_vars();
    [% IF ( hemisphere ) %]
	is_hemisphere = [% hemisphere %] ;
    hemispheres();
    [% END %]
[% END %]
[% IF ( irregularity ) %]
    irregularity_check();
[% END %]
    $('#numberpattern').change( function() { 
        reset_num_pattern(); 
    });

    var node;
    [% FOREACH field IN dont_export_field_loop %]
        node = $("#[% field.fieldid %]");
        if ( $(node).is('input') || $(node).is('textarea') ) {
            $(node).val("");
        } else if ( $(node).is('select') ) {
            $(node).find("option:first").attr('selected','selected');
        }
    [% END %]
});
//]]>
</script>
</head>
<body id="ser_subscription-add" class="ser">
[% INCLUDE 'header.inc' %] [% INCLUDE 'serials-search.inc' %] <div id="breadcrumbs"><a href="/cgi-bin/koha/mainpage.pl">Accueil</a> &rsaquo; <a href="/cgi-bin/koha/serials/serials-home.pl">Périodiques</a> &rsaquo; [% IF ( modify ) %]<a href="/cgi-bin/koha/serials/subscription-detail.pl?subscriptionid=[% subscriptionid %]"><i>[% bibliotitle |html %]</i></a> &rsaquo; Modifier l'abonnement[% ELSE %]Nouvel abonnement[% END %]</div>

<div id="doc3" class="yui-t7">
 
 <div id="bd">
<h1>[% IF ( modify ) %] Modifier l'abonnement pour <i>[% bibliotitle |html %]</i>[% ELSE %]Ajouter un abonnement[% END %]</h1>
 <div class="yui-g">
 <form method="post" name="f" action="/cgi-bin/koha/serials/subscription-add.pl">
[% IF ( modify ) %] <input type="hidden" name="op" value="modsubscription" />
 <input type="hidden" name="subscriptionid" value="[% subscriptionid %]" />
[% ELSE %] <input type="hidden" name="op" value="addsubscription" />
[% END %] <input type="hidden" name="user" value="[% loggedinusername %]" />
<input type="hidden" name="irreg_check" value="0" />
<input type="hidden" name="issuesexpected1" id="issuesexpected1" value="0" />

 <div class="yui-u first">
 <fieldset id="subscription_add_information" class="rows">
 <legend>Détails de l'abonnement</legend>
 <ol>
 [% IF ( subscriptionid ) %] <li><span class="label">Abonnement N°</span> [% subscriptionid %]</li>
 [% END %] <li>
 <label for="aqbooksellerid">Fournisseur&nbsp;:</label>
 <input type="text" name="aqbooksellerid" id="aqbooksellerid" value="[% aqbooksellerid %]" size="8" /> (<input type="text" name="aqbooksellername" value="[% aqbooksellername %]" disabled="disabled" readonly="readonly" />) <a href="#" onclick="FindAcqui(f)">Recherche d'un fournisseur</a>
 </li>
 <li>
 <label for="biblionumber" class="required" title="L'abonnement doit être associé à une notice bibliographique">Notice biblio&nbsp;: </label>
 
 <input type="text" name="biblionumber" id="biblionumber" value="[% bibnum %]" size="8" /> 
 (<input type="text" name="title" value="[% bibliotitle %]" disabled="disabled" readonly="readonly" />) <span class="required" title="L'abonnement doit être associé à une notice bibliographique">Obligatoire</span>
 <div class="inputnote"> <a href="#" onclick="Plugin(f)">Rechercher la notice</a>
 [% IF ( CAN_user_editcatalogue ) %] [% IF ( modify ) %] | <a href="#" onclick="addbiblioPopup([% bibnum %]); return false;">Modifier la notice</a>
 [% ELSE %] | <a href="#" onclick="addbiblioPopup(); return false;">Créer une notice</a>
 [% END %] [% END %] </div>
 
 </li>
 <li class="radio">
 [% IF ( serialsadditems ) %] <p><input type="radio" id="serialsadditems-yes" name="serialsadditems" value="1" checked="checked" /><label class="widelabel" for="serialsadditems-yes">Créer une notice d'exemplaire lorsque vous réceptionnez un bulletin</label></p>
 <p><input type="radio" id="serialsadditems-no" name="serialsadditems" value="0" /><label class="widelabel" for="serialsadditems-no">do not create an item record when receiving this serial </label></p>
 [% ELSE %] <p><input type="radio" id="serialsadditems-yes" name="serialsadditems" value="1"/><label class="widelabel" for="serialsadditems-yes">Créer une notice d'exemplaire lorsque vous réceptionnez un bulletin</label></p>
 <p><input type="radio" id="serialsadditems-no" name="serialsadditems" value="0" checked="checked" /><label class="widelabel" for="serialsadditems-no">do not create an item record when receiving this serial</label></p>
 [% END %] </li>
 <li>
 <label for="branchcode">Library:</label>
 
 <select name="branchcode" id="branchcode" style="width: 20em;">
 [% UNLESS ( Independantbranches ) %]<option value="">Aucun</option>[% END %] [% FOREACH branchloo IN branchloop %][% IF ( branchloo.selected ) %]<option value="[% branchloo.value %]" selected="selected">[% branchloo.branchname %]</option>
 [% ELSE %] <option value="[% branchloo.value %]">[% branchloo.branchname %]</option>
 [% END %] [% END %] </select> (sélectionnner un site)</li>
 <li>
 <label for="location">Localisation:</label>
 <select name="location" id="location">
 <option value="">Aucun</option>
 [% FOREACH locations_loo IN locations_loop %][% IF ( locations_loo.selected ) %]<option value="[% locations_loo.authorised_value %]" selected="selected">[% locations_loo.lib %]</option>[% ELSE %]<option value="[% locations_loo.authorised_value %]">[% locations_loo.lib %]</option>[% END %][% END %] </select>
 </li>
 <li>
 <label for="callnumber">Cote</label>
 <input type="text" name="callnumber" id="callnumber" value="[% callnumber %]" size="20" />
 </li>
 <li>
 <label for="graceperiod">Période de grâce :</label> <input type="text" name="graceperiod" id="graceperiod" value="[% graceperiod %]" size="5"/> jour(s) </li>
 <li>
 <label for="notes">Note OPAC&nbsp;:</label>
 <textarea name="notes" id="notes" cols="30" rows="2">[% notes %]</textarea>
 </li>
 <li>
 <label for="internalnotes">Note privée&nbsp;:</label>
 <textarea name="internalnotes" id="internalnotes" cols="30" rows="2">[% internalnotes %]</textarea>
 </li>
 <li>
 
 [% IF ( letterloop ) %] <label for="letter">Notifications de l'adhérent&nbsp;: </label>
 <select name="letter" id="letter">
 <option value="">Aucun</option>
 [% FOREACH letterloo IN letterloop %] [% IF ( letterloo.selected ) %] <option value="[% letterloo.value %]" selected="selected">[% letterloo.lettername %]</option>
[% ELSE %] <option value="[% letterloo.value %]">[% letterloo.lettername %]</option>
[% END %] [% END %] </select> 
 <div class="hint">Sélectionner une notice et les adhérents sur la liste de circulation recevront des notifications pour cet abonnement</div>
 [% ELSE %] <span class="label">Notifications de l'adhérent&nbsp;: </span>
 <div class="hint">Pour avertir les adhérents de la parution des nouveaux numéros de périodiques, vous devez <a href="/cgi-bin/koha/tools/letter.pl">définir une notification</a>.</div>
 [% END %] </li>
 <li>
 <label class="widelabel" for="staffdisplaycount">Nombre de fascicules à afficher aux bibliothécaires&nbsp;:</label>
 <input type="text" name="staffdisplaycount" id="staffdisplaycount" value="[% staffdisplaycount %]" size="4"/>
 </li>
 <li>
 <label class="widelabel" for="opacdisplaycount">Nombre de fascicules à afficher à l'OPAC : </label>
 <input type="text" name="opacdisplaycount" id="opacdisplaycount" value="[% opacdisplaycount %]" size="4"/>
 </li>
 </ol>
 </fieldset>
 </div>
 
<div class="yui-u">
<div id="subscription_form_history" style="display:none"><h3 style="display:inline">Historique de l'abonnement et état de collection sommaire</h3> <a href="#" id="cancel_manual_history">[masquer l'historique manuel]</a>
 <p>Astuce&nbsp;: vous pouvez mettre à jour l'historique manuellement. C'est utile pour un abonnement ancien, ou pour nettoyer un abonnement existant. Modifiez ces champs avec prudence, car le bulletinage ultérieur va continuer à les compléter.</p>
 <fieldset class="rows">
 <ol>
 <li>
 <label for="histstartdate">Subscription start date: </label>
 <input type="text" name="histstartdate" id="histstartdate" value="[% histstartdate %]" /><div class="hint"> (Date de début du premier abonnement)</div>
 </li>
 <li>
 <label for="histenddate">Subscription end date: </label>
 <input type="text" name="histenddate" id="histenddate" value="[% histenddate %]" /> <div class="hint">(si vide&nbsp;: l'abonnement est en cours)</div>
 </li>
 <li>
 <label for="recievedlist">Received issues: </label>
 <textarea name="recievedlist" id="recievedlist" cols="60" rows="5">[% recievedlist %]</textarea>
 </li>
 <li>
 <label for="missinglist">Missing issues: </label>
 <textarea name="missinglist" id="missinglist" cols="60" rows="5">[% missinglist %]</textarea>
 </li>
 <li>
 <label for="opacnote">Note for OPAC: </label>
 <textarea name="opacnote" id="opacnote" cols="60" rows="5">[% opacnote %]</textarea>
 </li>
 <li>
 <label for="librariannote">Note for staff: </label>
 <textarea name="librariannote" id="librariannote" cols="60" rows="5">[% librariannote %]</textarea>
 </li>
 </ol>
 </fieldset>
 <fieldset class="action"><input value="Enregistrer l'historique d'abonnement" type="submit" /></fieldset>
</div>

<div id="subscription_form_planning">
 <fieldset class="rows">
 <legend>Prévisionnel des périodiques</legend>
 <ol>
 <li>
 <label for="acqui_date"> Première date de parution&nbsp;:</label>
 [% IF ( modify ) %]<input type="text" name="firstacquidate" value="[% firstacquidate %]"  size="13" maxlength="10" id="acqui_date" disabled="disabled" />
 [% ELSE %]<input type="text" name="firstacquidate" value="[% firstacquidate %]"  size="13" maxlength="10" id="acqui_date" class="datepicker" />[% END %] </li>
 [% IF ( modify ) %]<li><label for="next_acqui_date"> Date de parution du prochain fascicule:</label>
 <input type="text" name="nextacquidate" value="[% nextacquidate %]" size="13" maxlength="10" id="next_acqui_date" class="datepicker" />
 </li>[% END %] <li>
 <label for="periodicity" class="required">Périodicité&nbsp;:</label>
 <select name="periodicity" size="1" id="periodicity" onchange="javascript:document.getElementsByName('manualhist')[0].checked=(this.value==1); reset_num_pattern();">
 <option value="" selected="selected">-- please choose --</option>
 [% IF ( periodicity16 ) %] <option value="16" selected="selected">Sans périodicité</option>
 [% ELSE %] <option value="16">Sans périodicité</option>
 [% END %] [% IF ( periodicity48 ) %] <option value="48" selected="selected">Inconnu</option>
 [% ELSE %] <option value="48">Inconnu</option>
 [% END %] [% IF ( periodicity32 ) %] <option value="32" selected="selected">Irrégulier</option>
 [% ELSE %] <option value="32">Irrégulier</option>
 [% END %] [% IF ( periodicity12 ) %] <option value="12" selected="selected">2/quotidien</option>
 [% ELSE %] <option value="12">2/quotidien</option>
 [% END %] [% IF ( periodicity1 ) %] <option value="1" selected="selected">quotidien (n/semaine)</option>
 [% ELSE %] <option value="1">quotidien (n/semaine)</option>
 [% END %] [% IF ( periodicity2 ) %] <option value="2" selected="selected">Hebdomadaire</option>
 [% ELSE %] <option value="2">Hebdomadaire</option>
 [% END %] [% IF ( periodicity3 ) %] <option value="3" selected="selected">Bimensuel </option>
 [% ELSE %] <option value="3">Bimensuel </option>
 [% END %] [% IF ( periodicity4 ) %] <option value="4" selected="selected">1/3 semaines</option>
 [% ELSE %] <option value="4">1/3 semaines</option>
 [% END %] [% IF ( periodicity5 ) %] <option value="5" selected="selected">Mensuel (1/mois)</option>
 [% ELSE %] <option value="5">Mensuel (1/mois)</option>
 [% END %] [% IF ( periodicity6 ) %] <option value="6" selected="selected">Bimestriel (6/an)</option>
 [% ELSE %] <option value="6">Bimestriel (6/an)</option>
 [% END %] [% IF ( periodicity7 ) %] <option value="7" selected="selected">Trimestriel (4/an)</option>
 [% ELSE %] <option value="7">Trimestriel (4/an)</option>
 [% END %]
 <!-- periodicity8 is 1/quarter, exactly like periodicity7 but will use it for seasonal option -->
 [% IF ( periodicity8 ) %]
 <option value="8" selected="selected">Trimestriel (saison)</option>
 [% ELSE %] <option value="8">Trimestriel (saison)</option>
 [% END %] [% IF ( periodicity13 ) %] <option value="13" selected="selected">1 tous les 4 mois (3/an)</option>
 [% ELSE %] <option value="13">1 tous les 4 mois (3/an)</option>
 [% END %] [% IF ( periodicity9 ) %] <option value="9" selected="selected">Semestriel (2/an)</option>
 [% ELSE %] <option value="9">Semestriel </option>
 [% END %] [% IF ( periodicity10 ) %] <option value="10" selected="selected">Annuel</option>
 [% ELSE %] <option value="10">Annuel</option>
 [% END %] [% IF ( periodicity11 ) %] <option value="11" selected="selected">Bisannuel</option>
 [% ELSE %] <option value="11">Bisannuel</option>
 [% END %] </select> <span class="required">Obligatoire</span></li>
 <li>
 <label for="manuallist"> Historique manuel&nbsp;:</label>
 [% IF ( manualhistory ) %] <input type="checkbox" name="manualhist" id="manuallist" value="1" checked="checked" />
 [% ELSE %] <input type="checkbox" name="manualhist" id="manuallist" value="1" />
 [% END %] </li>
 <li>
 <label for="numberpattern"> Modèle de numérotation&nbsp;:</label>
 
 <select name="numbering_pattern" size="1" id="numberpattern" >
 <option value="" selected="selected">-- please choose --</option>
 [% IF ( numberpattern1 ) %] <option value="1" selected="selected">Numéro</option>
 [% ELSE %] <option value="1">Numéro</option>
 [% END %] [% IF ( numberpattern2 ) %] <option value="2" selected="selected">Volume, Numéro, Fascicule</option>
 [% ELSE %] <option value="2">Volume, Numéro, Fascicule</option>
 [% END %] [% IF ( numberpattern3 ) %] <option value="3" selected="selected">Volume, Numéro</option>
 [% ELSE %] <option value="3">Volume, Numéro</option>
 [% END %] [% IF ( numberpattern4 ) %] <option value="4" selected="selected">Volume, Fascicule</option>
 [% ELSE %] <option value="4">Volume, Fascicule</option>
 [% END %] [% IF ( numberpattern5 ) %] <option value="5" selected="selected">Numéro, Fascicule</option>
 [% ELSE %] <option value="5">Numéro, Fascicule</option>
 [% END %] [% IF ( numberpattern6 ) %] <option value="6" selected="selected">Seulement saisonnier</option>
 [% ELSE %] <option value="6">Seulement saisonnier</option>
 [% END %] [% IF ( numberpattern8 ) %] <option value="8" selected="selected">Année/Nombre</option>
 [% ELSE %] <option value="8">Année/Nombre</option>
 [% END %] [% IF ( numberpattern7 ) %] <option value="7" selected="selected">Aucun de ci-dessus</option>
 [% ELSE %] <option value="7">Aucun de ci-dessus</option>
 [% END %] </select>
 </li>
 <li id="more_options"></li>
 <li id="irregularity"></li>
 <li id="displayexample"></li>
 <li>
 <label for="from" class="required"> Date de début de l'abonnement&nbsp;:</label>
 <input type="text" name="startdate" value="[% startdate %]" size="13" maxlength="10" id="from" class="datepickerfrom" />
 <span class="required">Obligatoire</span>
 </li>
 <li>
 <label for="subtype" class="required">Durée d'abonnement&nbsp;:</label>
 
 <select name="subtype" id="subtype">
 [% IF ( subtype_monthlength ) %]<option value="monthlength" selected="selected">[% ELSE %]<option value="monthlength">[% END %] Nombre de mois</option>
 [% IF ( subtype_numberlength ) %]<option value="numberlength" selected="selected">[% ELSE %]<option value="numberlength">[% END %] Nombre de numéros</option>
 [% IF ( subtype_weeklength ) %]<option value="weeklength" selected="selected">[% ELSE %]<option value="weeklength">[% END %] Nombre de semaines</option>
 </select>
 <input type="text" id="numberlength" name="sublength" value="[% sublength %]" size="3" onkeypress="return check_input(event)" /> (entrer le montant en chiffre) <span class="required">Obligatoire</span>
 </li>
 <li>
 <label for="to"> Date de fin d'abonnement:</label>
 <input type="text" name="enddate" value="[% enddate %]" size="13" maxlength="10" id="to" class="datepickerto" />
 </li>
 <li><label for="numberingmethod">Formule de numérotation&nbsp;: </label> <input type="text" name="numberingmethod" id="numberingmethod" value="[% numberingmethod %]" />
 </li>
 </ol>
 </fieldset>

 <fieldset class="action">
 <input value="Tester le prévisionnel de bulletinage" type="button" class="action_test" onclick="javascript:irregularity_check()" />
 <input value="Restaurer modèle" type="button" class="action_reset" onclick="javascript:reset_pattern()" />
 <input accesskey="w" value="Enregistrer abonnement" type="button" class="action_save" onclick="Check(this.form)" />
 </fieldset>
 <fieldset class="action">
 <input type="button" class="action_advanced" value="Show/Hide advanced pattern" onclick="javascript:display_table()" />
 </fieldset>
 <div id="basetable"  style="display: none;">
 <table class="small">
 <tr><th colspan="4">Prévisionnel avancé</th></tr>
 <tr>
 <th>&nbsp;</th>
 <th>X</th>
 <th>Y</th>
 <th>Z</th>
 </tr>
 <tr>
 <td>Ajouter</td>
 <td>
 <input type="text" name="add1" id="add1" value="[% add1 %]" />
 </td>
 <td>
 <input type="text" name="add2" id="add2" value="[% add2 %]" />
 </td>
 <td>
 <input type="text" name="add3" id="add3" value="[% add3 %]" />
 </td>
 </tr>
 <tr>
 <td>chaque</td>
 <td><input type="text" name="every1" id="every1" value="[% every1 %]" /></td>
 <td><input type="text" name="every2" id="every2" value="[% every2 %]" /></td>
 <td><input type="text" name="every3" id="every3" value="[% every3 %]" /></td>
 </tr>
 <tr>
 <td>Quand supérieur à</td>
 <td><input type="text" name="whenmorethan1" id="whenmorethan1" value="[% whenmorethan1 %]" /></td>
 <td><input type="text" name="whenmorethan2" id="whenmorethan2" value="[% whenmorethan2 %]" /></td>
 <td><input type="text" name="whenmorethan3" id="whenmorethan3" value="[% whenmorethan3 %]" /></td>
 </tr>
 <tr>
 <td>compteur interne</td>
 <td><input type="text" name="innerloop1" id="innerloop1" value="[% innerloop1 %]" /></td>
 <td><input type="text" name="innerloop2" id="innerloop2" value="[% innerloop2 %]" /></td>
 <td><input type="text" name="innerloop3" id="innerloop3" value="[% innerloop3 %]" /></td>
 </tr>
 <tr>
 <td>Retourner à</td>
 <td><input type="text" name="setto1" id="setto1" value="[% setto1 %]" /></td>
 <td><input type="text" name="setto2" id="setto2" value="[% setto2 %]" /></td>
 <td><input type="text" name="setto3" id="setto3" value="[% setto3 %]" /></td>
 </tr>
 <tr>
 <td>
 [% IF ( modify ) %] Valeur de fin [% ELSE %] Commence par [% END %] </td>
 <td><input type="text" name="lastvalue1" id="lastvalue1" value="[% lastvalue1 %]" /></td>
 <td><input type="text" name="lastvalue2" id="lastvalue2" value="[% lastvalue2 %]" /></td>
 <td><input type="text" name="lastvalue3" id="lastvalue3" value="[% lastvalue3 %]" /></td>
 </tr>
 </table>
 </div>

</div>
</div>
</form>
</div>

</div>

[% INCLUDE 'intranet-bottom.inc' %] 